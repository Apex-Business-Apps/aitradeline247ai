name: Synthetic Smoke Tests

on:
  schedule:
    - cron: '*/5 * * * *' # Every 5 minutes
  workflow_dispatch: # Allow manual trigger

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test apex ‚Üí www redirect
        id: apex-redirect
        continue-on-error: true
        run: |
          RESPONSE=$(curl -I -s -L https://tradeline247ai.com)
          if echo "$RESPONSE" | grep -q "301\|308"; then
            if echo "$RESPONSE" | grep -q "Location: https://www.tradeline247ai.com"; then
              echo "‚úÖ Apex redirect OK"
              exit 0
            else
              echo "‚ùå Apex redirect location incorrect"
              exit 1
            fi
          else
            echo "‚ùå Apex redirect not 301/308"
            exit 1
          fi
      
      - name: Test healthz endpoint
        id: healthz
        continue-on-error: true
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://www.tradeline247ai.com/healthz)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ /healthz OK"
            exit 0
          else
            echo "‚ùå /healthz returned $STATUS"
            exit 1
          fi
      
      - name: Test readyz endpoint
        id: readyz
        continue-on-error: true
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://www.tradeline247ai.com/readyz)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ /readyz OK"
            exit 0
          else
            echo "‚ùå /readyz returned $STATUS"
            exit 1
          fi
      
      - name: Test icon asset
        id: icon
        continue-on-error: true
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://www.tradeline247ai.com/assets/icon-192.png)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ icon-192.png OK"
            exit 0
          else
            echo "‚ùå icon-192.png returned $STATUS"
            exit 1
          fi
      
      - name: Test release tarball
        id: release-tarball
        continue-on-error: true
        run: |
          curl -f -o /tmp/release.tar.gz https://www.tradeline247ai.com/download/release.tar.gz
          curl -f -o /tmp/release.tar.gz.sha256 https://www.tradeline247ai.com/download/release.tar.gz.sha256
          
          cd /tmp
          EXPECTED=$(cat release.tar.gz.sha256 | awk '{print $1}')
          ACTUAL=$(sha256sum release.tar.gz | awk '{print $1}')
          
          if [ "$EXPECTED" = "$ACTUAL" ]; then
            echo "‚úÖ Release tarball SHA256 matches"
            exit 0
          else
            echo "‚ùå SHA256 mismatch: expected $EXPECTED, got $ACTUAL"
            exit 1
          fi
      
      - name: Create failure issue
        if: |
          steps.apex-redirect.outcome == 'failure' ||
          steps.healthz.outcome == 'failure' ||
          steps.readyz.outcome == 'failure' ||
          steps.icon.outcome == 'failure' ||
          steps.release-tarball.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const failures = [];
            if ('${{ steps.apex-redirect.outcome }}' === 'failure') failures.push('apex redirect');
            if ('${{ steps.healthz.outcome }}' === 'failure') failures.push('/healthz');
            if ('${{ steps.readyz.outcome }}' === 'failure') failures.push('/readyz');
            if ('${{ steps.icon.outcome }}' === 'failure') failures.push('icon-192.png');
            if ('${{ steps.release-tarball.outcome }}' === 'failure') failures.push('release tarball');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Synthetic Smoke Test Failure',
              body: `**Failed Checks:** ${failures.join(', ')}\n\n` +
                    `**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n` +
                    `**Timestamp:** ${new Date().toISOString()}\n\n` +
                    `Please investigate and resolve immediately.`,
              labels: ['smoke-test-failure', 'ops']
            });
      
      - name: Report success
        if: |
          steps.apex-redirect.outcome == 'success' &&
          steps.healthz.outcome == 'success' &&
          steps.readyz.outcome == 'success' &&
          steps.icon.outcome == 'success' &&
          steps.release-tarball.outcome == 'success'
        run: |
          echo "‚úÖ All synthetic smoke tests passed"
