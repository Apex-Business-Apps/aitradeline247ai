name: ios-build-upload

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ios:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash
    env:
      BASE_URL: https://www.tradeline247ai.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps & build web
        run: |
          npm ci
          npm run build

      - name: Generate iOS project (idempotent)
        run: |
          if [ ! -d ios ]; then npx cap add ios; fi
          npx cap copy ios

      - name: Ensure Podfile present
        run: |
          test -f ios/App/Podfile || (echo "Missing ios/App/Podfile" && exit 1)

      - name: Install Fastlane & CocoaPods
        run: |
          gem install fastlane --no-document
          sudo gem install cocoapods --no-document
          cd ios/App
          pod repo update
          pod install --repo-update

      - name: Archive (Xcode Managed Signing)
        run: |
          set -e
          WORKSPACE="ios/App/App.xcworkspace"
          SCHEME="App"
          ARCHIVE_PATH="$PWD/ios/build/App.xcarchive"
          xcodebuild -workspace "$WORKSPACE" \
                     -scheme "$SCHEME" \
                     -configuration Release \
                     -archivePath "$ARCHIVE_PATH" \
                     -allowProvisioningUpdates archive

      - name: Export IPA
        run: |
          cat > ExportOptions.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>method</key><string>app-store</string>
              <key>uploadSymbols</key><true/>
              <key>compileBitcode</key><false/>
              <key>signingStyle</key><string>automatic</string>
            </dict>
          </plist>
          PLIST

          EXPORT_PATH="$PWD/ios/build/export"
          mkdir -p "$EXPORT_PATH"
          xcodebuild -exportArchive \
            -archivePath "$PWD/ios/build/App.xcarchive" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates

          echo "IPA_PATH=$EXPORT_PATH/App.ipa" >> $GITHUB_ENV

      - name: Upload to TestFlight (Fastlane)
        env:
          ASC_API_KEY_ID:     ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_ISSUER_ID:  ${{ secrets.ASC_API_ISSUER_ID }}
          ASC_API_KEY:        ${{ secrets.ASC_API_KEY }}
          IPA_PATH:           ${{ env.IPA_PATH }}
        run: |
          fastlane ios upload
